#!/usr/bin/env bash
# kubctl-0x03 - Rolling Update Automation Script
# Author: Lewis
# Purpose: Perform a zero-downtime rolling update of the Django app

set -e
set -o pipefail

DEPLOYMENT_NAME="messaging-app-blue"
SERVICE_NAME="messaging-app-service"
DEPLOYMENT_FILE="messaging_app/blue_deployment.yaml"

echo "🚀 Starting rolling update for $DEPLOYMENT_NAME..."
kubectl apply -f "$DEPLOYMENT_FILE"

echo "🔄 Monitoring rollout status..."
kubectl rollout status deployment/"$DEPLOYMENT_NAME"

# Get service URL (works for Minikube)
SERVICE_URL=$(minikube service "$SERVICE_NAME" --url)
echo "🌐 Accessing service at: $SERVICE_URL"

echo "🧪 Testing service availability during update..."
for i in {1..20}; do
  STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SERVICE_URL")
  if [ "$STATUS" -eq 200 ]; then
    echo "✅ Request $i: Service is up (HTTP $STATUS)"
  else
    echo "⚠️ Request $i: Possible downtime (HTTP $STATUS)"
  fi
  sleep 2
done

echo "📋 Checking rollout history..."
kubectl rollout history deployment/"$DEPLOYMENT_NAME"

echo "🔍 Verifying running pods..."
kubectl get pods -l app=messaging-app,version=blue -o wide

echo "🎯 Rolling update complete and verified!"
